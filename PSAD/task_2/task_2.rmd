---
title: "Статистический анализ данных (задание 2)."
subtitle: "Работа с реальными данными. Проверка гипотез."
author: "Юлия Лукашкина, 417 группа"
output: html_document
---
Требуется подобрать и применить наилучший статистический метод, позволяющий ответить на вопрос прикладной задачи; обосновать выбор метода, его применимость и оптимальность. Помимо выводов, касающихся математических особенностей решения, необходимо в терминах предметной области сформулировать выводы, которые могли бы быть понятны гипотетическому заказчику-нематематику.

```
Измерено 150 черепов, найденных при раскопках в Египте. Находки относятся к пяти различным временным периодам. Для каждого черепа известны: максимальная ширина, базибрегматическая высота, базиальвеолярная длина, высота носа, примерная дата формирования.
```

Задание: *проверить, есть ли различия между размерами черепов различных временных периодов*?

Загрузка данных:

```{r, cache=TRUE}
skulls <- read.delim("Q:/PSAD/task2/skulls.txt")
colnames(skulls) <- c("w", "h", "l", "n", "y")
```

Посмотрим, что из себя представляют данные. 

```{r, cache=TRUE}
str(skulls)
table(skulls$y)
```
Видно, что распределение числа черепов по разным временным эпохам равномерно.
Рассмотрим гипотезу о равенстве средних значений **максимальной ширины** черепов разных периодов.

```{r, cache=TRUE, warning=FALSE}
boxplot(skulls$w ~ skulls$y)
```

Выясним, нормальны ли распределения значения ширины черепов внутри каждого периода, применим критерий Шапиро-Уилка для проверки нормальности, p-values:
```{r, cache=TRUE, warning=FALSE, echo=FALSE}
w <- split(skulls$w, skulls$y)
p <- NULL
p["-4000"] <- shapiro.test(w[[1]])$p.value
p["-3300"] <- shapiro.test(w[[2]])$p.value
p["-1850"] <- shapiro.test(w[[3]])$p.value
p["-200"]  <- shapiro.test(w[[4]])$p.value
p["150"]   <- shapiro.test(w[[5]])$p.value
p
```

Для данных за период времени -1850 и -3300 гипотеза о нормальности не подтверждаются, поэтому будем использовать методы, не требующие нормальности выборок. Будем использовать критерий знаковых рангов Уилкоксона для проверки равенства медиан, данный ритери проверяет гипотезу

$H_0:\;med X = m_0;$ против альтернативы 

$H1:\;med X \ne m_0.$


```{r, cache=TRUE, warning=FALSE}
pairwise.wilcox.test(skulls$w, skulls$y, p.adjust.method="none")
```

Без поправки на множественность отвергаются гипотезы о равенстве средних значений максимальной ширины черепов у пар

+ -4000  -1850
+ -4000  -200
+ -4000   150
+ -3300  -1850
+ -3300  -200
+ -3300   150

Так как мы рассматримаем задачу множественной проверки гипотез, рассмотрим поправку на множественность. Так как m (количество гипотез) достаточно мало, то можно применить поправку Бонферрони не беспокоясь о мощность статистической процедуры.

```{r, cache=TRUE, warning=FALSE}
pairwise.wilcox.test(skulls$w,skulls$y, p.adjust.method="bonferroni")
```

C учетом  поправки отвергаются гипотезы о равенстве средних значений максимальной ширины черепов у пар:

+ -4000  -200
+ -4000   150
+ -3300  -200
+ -3300   150


Используем Критерий Джонкхиера для проверки гипотезы равенства средних против альтернативы  их увеличения.

$H_0:\; med X_1 = \dots = med X_m$

$H_1:\; med X_1 \le \dots \le med X_m$

```{r, cache=TRUE, warning=FALSE}
library(clinfun)
jonckheere.test(skulls$w, skulls$y, alternative = "increasing")
```

p-value свидетельствует против нулевой гипотезы в пользу альтернативы. Можно сделать вывод, что среднее значение ширины черепа увеличивалось со временем.

Рассмотрим теперь показатели **базибрегматической высоты черепов**. 

```{r, cache=TRUE, warning=FALSE}
par(mfrow=c(1,1))
boxplot(skulls$h ~ skulls$y)
h <- split(skulls$h, skulls$y)
```

Проверим подвыборки на нормальность. p-values критерия Шапиро-Уилка для проверки нормальности:

```{r, cache=TRUE, warning=FALSE, echo=FALSE}
p <- NULL
p["-4000"] <- shapiro.test(h[[1]])$p.value
p["-3300"] <- shapiro.test(h[[2]])$p.value
p["-1850"] <- shapiro.test(h[[3]])$p.value
p["-200"]  <- shapiro.test(h[[4]])$p.value
p["150"]   <- shapiro.test(h[[5]])$p.value
p
```
Гипотезы о нормальности не отвергаются, воспользуемся тестом Стьюдента для попарной проверки равенства средних с поправкой на множественность.


```{r, cache=TRUE, warning=FALSE}
pairwise.t.test(skulls$h,skulls$y, p.adjust.method="bonferroni")
```

Из полученных результатов можно сделать вывод, что средние значения базибрегматической высоты черепов примерно равны для различных периодов.

```{r, cache=TRUE, warning=FALSE}
bartlett.test(h~y, data=skulls)
```

Гипотеза о равенстве дисперсий не отклоняется.

Рассмотрим значения **базиальвеолярной длины черепов**. Проверим гипотезу о равенстве их средних для различных временных эпох. 

```{r, cache=TRUE, warning=FALSE}
boxplot(skulls$l ~ skulls$y)
l <- split(skulls$l, skulls$y)
```

Проверим подвыборки на нормальность. p-values критерия Шапиро-Уилка для проверки нормальности:

```{r, cache=TRUE, warning=FALSE, echo=FALSE}
p <- NULL
p["-4000"] <- shapiro.test(l[[1]])$p.value
p["-3300"] <- shapiro.test(l[[2]])$p.value
p["-1850"] <- shapiro.test(l[[3]])$p.value
p["-200"]  <- shapiro.test(l[[4]])$p.value
p["150"]   <- shapiro.test(l[[5]])$p.value
p
```


```{r, cache=TRUE, warning=FALSE}
jonckheere.test(skulls$l, skulls$y)
```

Гипотеза о равенстве средних отклоняется. Общая гипотеза однородности отвергается, подвыборки -- нормальные, воспользуемся LSD (Least Significant Difference) Фишера, получим красивый график.

```{r, cache=TRUE, warning=FALSE}
library(agricolae)
a1   <- aov(skulls$l~skulls$y)
LSD1 <- LSD.test(a1, "skulls$y", p.adj="none",console=TRUE)
bar.err(LSD1$means, variation="SE", ylim = c(92, 105), bar=FALSE,col=0)
grid()
```

Проверим гипотезу о равенстве средних против односторонней альтернативы их уменьшения.

$H_0:\; med X_1 = \dots = med X_m$

$H_1:\; med X_1 \le \dots \le med X_m$

```{r, cache=TRUE, warning=FALSE}
jonckheere.test(skulls$l, skulls$y, alternative = "decreasing")
```

Гипотеза о равенстве отвергается  в пользу альтернативы. Средняя длина черепа уменьшалась с увеличением примерной даты формирования. 

Рассмотрим данные о **высоте носа**. 

```{r, cache=TRUE, warning=FALSE}
boxplot(skulls$n ~ skulls$y)
n <- split(skulls$n, skulls$y)
```

p-values критерия Шапиро-Уилка для проверки нормальности:

```{r, cache=TRUE, warning=FALSE, echo=FALSE}
p <- NULL
p["-4000"] <- shapiro.test(n[[1]])$p.value
p["-3300"] <- shapiro.test(n[[2]])$p.value
p["-1850"] <- shapiro.test(n[[3]])$p.value
p["-200"]  <- shapiro.test(n[[4]])$p.value
p["150"]   <- shapiro.test(n[[5]])$p.value
p
```

```{r, cache=TRUE, warning=FALSE}
pairwise.t.test(skulls$n,skulls$y, p.adjust.method="bonferroni")
```

Гипотеза о равенстве средних не отвергается. Можно сделать вывод, что длина носа не зависит от периода формирования черепа.


По результатам полученным выше можно предположить, что все черепа можно примерно разделить на 2 группы: -4000, -3300 и -1850,-200, 150. Проверим данное предположение, исследуем значения ширины и длины черепов для двух данных групп.

```{r, cache=TRUE, warning=FALSE}
f <- factor(skulls$y == "-4000" | skulls$y == "-3300")
tmp <- split(skulls, f)
skulls_old   <- tmp[[2]]
skulls_young <- tmp[[1]]

shapiro.test(skulls_old$w)
shapiro.test(skulls_young$w)
bartlett.test(w~f, data=skulls)
t.test(skulls_old$w, skulls_young$w, alternative="less")
```
95% доверительный интервал для разности: $(-\infty,\; -2.207582)$
Гипотеза о равенстве отвергается в пользу односторонней альтернативы. Проверим, что внутри групп средние совпадают. 

```{r, cache=TRUE, warning=FALSE}
w <- split(skulls_old$w, skulls_old$y)
wilcox.test(w[[1]], w[[2]])

w <- split(skulls_young$w, skulls_young$y)
pairwise.wilcox.test(skulls_young$w,skulls_young$y, p.adjust.method="bonferroni")

```
p-value большие, гипотеза о равенстве средних внутри групп принимается.
Рассмотрим длину черепов.

```{r, cache=TRUE, warning=FALSE}
shapiro.test(skulls_old$l)
shapiro.test(skulls_young$l)

t.test(skulls_old$l, skulls_young$l, alternative="greater")

l <- split(skulls_old$l, skulls_old$y)
wilcox.test(l[[1]], l[[2]])

l <- split(skulls_young$l, skulls_young$y)
pairwise.wilcox.test(skulls_young$w,skulls_young$y, p.adjust.method="bonferroni")
```


Выводы:

+ все черепа можно примерно разделить на 2 группы по временному периоду: -4000, -3300 и -1850,-200, 150.  В первой группе средняя ширина черепа меньше, чем во второй. 95% доверительный интервал для разности средних: $(-\infty,\; -2.207582)$. Однако, средняя длина черепа больше в первой группе. 95% доверительный интервал для разности в длине черепа: $(3.046352,\;\infty)$.
+ среднее значение ширины черепа увеличивалось со временем,
+ средние значения базибрегматической высоты черепов примерно равны для различных периодов,
+ длина черепа уменьшалась с увеличением примерной даты формирования, 
+ длина носа не зависит от периода формирования черепа
